{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
  <link href="{% static 'css/persona/persona.css' %}" rel="stylesheet">
  <style>
  /* 활성화된 버튼 스타일 */
  .option-btn.active {
    background-color: #6366f1; /* Primary color */
    color: white;
    border-color: #6366f1;
  }

  /* --- 모달 스타일 시작 --- */
  .persona-modal {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex; /* display:block 에서 flex로 변경하여 중앙정렬 */
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .persona-modal__backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
  }

  .persona-modal__content {
    position: relative;
    width: 100%;
    max-width: 300px; /* 이미지와 비슷한 너비로 조절 */
    background: #ffffff;
    color: #1f2937; /* 다크 텍스트 */
    border-radius: 20px;
    padding: 32px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    text-align: center;
    transform: translateY(-20px);
    opacity: 0;
    animation: modal-fade-in 0.3s forwards;
  }

  @keyframes modal-fade-in {
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  /* --- 원형 프로그레스 바 --- */
  .progress-circle {
    position: relative;
    width: 140px;
    height: 140px;
    border-radius: 50%;
    margin: 0 auto 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: conic-gradient(
      #6366f1 calc(var(--progress-percent) * 1%), 
      #e5e7eb calc(var(--progress-percent) * 1%)
    );
  }

  .progress-circle::before {
    content: '';
    position: absolute;
    width: 110px;
    height: 110px;
    background: #fff;
    border-radius: 50%;
  }

  .progress-circle__percent {
    position: relative;
    font-size: 32px;
    font-weight: 700;
    color: #6366f1;
  }

  .progress-circle__label {
    position: relative;
    font-size: 14px;
    color: #6b7280;
    margin-top: -4px;
  }


  /* --- 페르소나 정보 --- */
  .persona-info h3 {
    margin: 0 0 8px 0;
    font-size: 22px;
    font-weight: 700;
  }

  #persona-details {
    margin: 8px 0 0;
    color: #4b5563;
    line-height: 1.6;
    text-align: left;
  }


  /* --- 모달 버튼 --- */
  .persona-modal__actions {
    display: flex; /* grid에서 flex로 변경 */
    justify-content: center; /* 중앙 정렬 추가 */
    gap: 12px;
    margin-top: 32px;
  }

  .btn-primary, .btn-secondary {
    padding: 12px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 12px;
    text-decoration: none;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s;
    text-align: center;
    flex: 1;
    display: inline-flex;     /* 모든 버튼의 동작 방식을 flex로 통일 */
    justify-content: center; /* 텍스트 가로 중앙 정렬 */
    align-items: center;     /* 텍스트 세로 중앙 정렬 */
  }

  .btn-primary {
    background-color: #6366f1;
    color: #fff;
    border-color: #6366f1;
  }
  .btn-primary:hover {
    background-color: #4f46e5;
  }

  .btn-secondary {
    background-color: #f3f4f6;
    color: #4b5563;
    border-color: #e5e7eb;
  }
  .btn-secondary:hover {
    background-color: #e5e7eb;
  }
  </style>
{% endblock %}

{% block title %}페르소나 조건 선택{% endblock %}

{% block content %}
<div class="persona-create-wrapper">
  <h2 class="persona-title">페르소나 조건 선택</h2>
  
  <form method="GET" action="{% url 'persona:find_and_chat' %}" id="persona-form">

    <div class="form-section">
      <label>성별</label>
      <div class="btn-group" data-input-name="gender">
        {% for gender in gender_options %}<button type="button" class="option-btn">{{ gender }}</button>{% endfor %}
      </div>
    </div>

    <div class="form-section">
      <label>연령대</label>
      <div class="btn-group" data-input-name="age">
        {% for age in age_options %}<button type="button" class="option-btn">{{ age }}</button>{% endfor %}
      </div>
    </div>

    <div class="form-section">
      <label>직업</label>
      <div class="btn-group" data-input-name="job">
        {% for item in job_options %}<button type="button" class="option-btn">{{ item }}</button>{% endfor %}
      </div>
    </div>

    <div class="form-section">
      <label>가족 구성</label>
      <div class="btn-group" data-input-name="household">
        {% for item in household_options %}<button type="button" class="option-btn">{{ item }}</button>{% endfor %}
      </div>
    </div>

    <div class="form-section">
      <label>소득</label>
      <div class="btn-group" data-input-name="income_month">
        {% for item in income_month_options %}<button type="button" class="option-btn">{{ item }}</button>{% endfor %}
      </div>
    </div>

    <div class="form-section">
      <label>라이프스타일</label>
      <div class="btn-group" data-input-name="segment">
        {% for item in segment_options %}<button type="button" class="option-btn">{{ item }}</button>{% endfor %}
      </div>
    </div>

    <div id="hidden-inputs"></div>

    <button type="submit" class="submit-btn">설정</button>
  </form>
</div>

<!-- 모달 마크업 -->
<div id="persona-modal" class="persona-modal" style="display:none;">
  <div class="persona-modal__backdrop"></div>
  <div class="persona-modal__content">
    
    <div class="progress-circle" style="--progress-percent: 0;">
      <div class="progress-circle__percent">0%</div>
      <div class="progress-circle__label">일치율</div>
    </div>

    <div class="persona-info">
      <h3 id="persona-name"></h3>
      <div id="persona-details"></div>
    </div>

    <div class="persona-modal__actions">
      <button id="persona-modal-close" type="button" class="btn-secondary">재설정</button>
      <a id="persona-modal-link" href="#" class="btn-primary">채팅 시작</a>
    </div>
  </div>
</div>

<script>
(function(){
  const form = document.getElementById('persona-form');
  const submitBtn = form.querySelector('.submit-btn');
  const hiddenInputsContainer = document.getElementById('hidden-inputs');

  // --- 모달 refs ---
  const modal = document.getElementById('persona-modal');
  const modalClose = document.getElementById('persona-modal-close');
  const modalLink  = document.getElementById('persona-modal-link');
  const progressCircle = modal.querySelector('.progress-circle');
  const progressPercent = modal.querySelector('.progress-circle__percent');
  const personaName = document.getElementById('persona-name');
  const personaDetails = document.getElementById('persona-details');

  // (openModal, closeModal, syncHiddenInputs, 버튼 토글 로직은 이전과 동일)
  const openModal = (data) => {
    if (!data || data.error) {
      progressCircle.style.display = 'none';
      personaName.textContent = data?.title || '오류';
      personaDetails.innerHTML = data?.body || '문제가 발생했습니다.';
      modalLink.style.display = 'none';
      modalClose.textContent = '닫기';
      modal.style.display = 'flex';
      return;
    }
    progressCircle.style.display = 'flex';
    const pct = data.match_percentage || 0;
    progressCircle.style.setProperty('--progress-percent', pct);
    progressPercent.textContent = `${pct}%`;
    personaName.textContent = `페르소나 ${data.persona_id} - ${data.persona_data.name}`;
    
    const p_data = data.persona_data;
    const details = [
        `<strong>나이/성별:</strong> ${p_data.age} / ${p_data.gender}`,
        `<strong>직업:</strong> ${p_data.job}`,
        `<strong>가구:</strong> ${p_data.household}`,
        `<strong>소득:</strong> ${p_data.income_month} (${p_data.income_status})`,
        `<strong>지역:</strong> ${p_data.region}`,
        `<strong>학력:</strong> ${p_data.education}`,
        `<strong>결혼:</strong> ${p_data.marriage}`,
        `<strong>라이프스타일:</strong> ${p_data.segment}`
    ];
    
    let detailsHtml = details.join('<br>');

    if (p_data.persona_description) {
        detailsHtml += `<p style="margin-top: 12px;"><strong>페르소나 설명:</strong><br>${p_data.persona_description}</p>`;
    }

    personaDetails.innerHTML = detailsHtml;

    if (data.redirect_url) {
        modalLink.style.display = 'inline-flex';
        modalLink.href = data.redirect_url;
        modalLink.textContent = '채팅 시작';
    } else {
        modalLink.style.display = 'none';
    }
    modalClose.textContent = '재설정';
    modal.style.display = 'flex';
  };
  const closeModal = () => { modal.style.display = 'none'; };
  modalClose.addEventListener('click', closeModal);
  modal.querySelector('.persona-modal__backdrop').addEventListener('click', closeModal);
  document.querySelectorAll('.btn-group').forEach(group => {
    group.querySelectorAll('.option-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        group.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      });
    });
  });
  const syncHiddenInputs = () => {
    hiddenInputsContainer.innerHTML = '';
    document.querySelectorAll('.btn-group').forEach(group => {
      const inputName = group.dataset.inputName;
      if (!inputName) return;
      const active = group.querySelector('.option-btn.active');
      if (active) {
        const input = document.createElement('input');
        input.type  = 'hidden';
        input.name  = inputName;
        input.value = active.textContent.trim();
        hiddenInputsContainer.appendChild(input);
      }
    });
  };

  // 1. 선택되지 않은 항목을 찾아주는 함수 (새로 추가)
  const getUnselectedCategories = () => {
    const unselected = [];
    document.querySelectorAll('.form-section').forEach(section => {
      const group = section.querySelector('.btn-group');
      const label = section.querySelector('label');
      if (group && label && !group.querySelector('.option-btn.active')) {
        unselected.push(label.textContent.trim());
      }
    });
    return unselected;
  };

  // 2. 실제 폼 전송 로직을 별도 함수로 분리 (새로 추가)
  const proceedWithSubmission = async () => {
    syncHiddenInputs();
    const params = new URLSearchParams(new FormData(form));
    const url = `${form.getAttribute('action')}?${params.toString()}`;

    const prevText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = '선택 중...';

    try {
      const resp = await fetch(url, {
        method: 'GET',
        headers: { 'Accept': 'application/json, text/html;q=0.9' },
      });

      if (resp.redirected) {
        openModal({ match_percentage: 100, persona_id: 'N/A', persona_data: { name: '추천 페르소나'}, redirect_url: resp.url });
      } else if (resp.headers.get('Content-Type')?.includes('application/json')) {
        const data = await resp.json();
        openModal(data);
      } else {
        openModal({ error: true, title: '결과 확인 불가', body: '페이지를 새로고침 후 다시 시도해 주세요.'});
      }
    } catch (err) {
      console.error(err);
      openModal({ error: true, title: '요청 오류', body: '처리 중 문제가 발생했습니다.' });
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = prevText;
    }
  };


  // 3. '설정' 버튼 클릭 시의 로직을 수정
  form.addEventListener('submit', async (e) => {
    e.preventDefault(); // 폼의 기본 동작(페이지 이동)을 항상 막습니다.
    
    const unselectedItems = getUnselectedCategories();

    // 모든 항목이 선택되었을 경우
    if (unselectedItems.length === 0) {
      proceedWithSubmission(); // 바로 전송 로직 실행
    } 
    // 선택되지 않은 항목이 있을 경우
    else {
      // 확인 모달을 띄웁니다.
      progressCircle.style.display = 'none';
      personaName.textContent = '선택하지 않은 항목이 있습니다';
      // 선택되지 않은 항목 목록을 예쁘게 만듭니다.
      const itemsList = unselectedItems.map(item => `<li>- ${item}</li>`).join('');
      personaDetails.innerHTML = `
        <span>아래 항목은 랜덤으로 지정됩니다:</span>
        <ul style="list-style: none; padding-left: 10px; margin-top: 8px; margin-bottom: 16px;">
          ${itemsList}
        </ul>
        <span>이대로 계속 진행할까요?</span>
      `;
      
      modalLink.style.display = 'inline-flex';
      modalLink.textContent = '네, 계속 진행'; // 버튼 텍스트 변경
      modalLink.href = '#'; // 링크 기능은 잠시 무효화
      
      modalClose.textContent = '돌아가서 선택';
      
      modal.style.display = 'flex';

      // '네, 계속 진행' 버튼을 눌렀을 때만 폼 전송
      modalLink.onclick = (event) => {
        event.preventDefault();
        closeModal();
        proceedWithSubmission();
        modalLink.onclick = null; // 이벤트 핸들러 정리
      };
    }
  });
})();
</script>
{% endblock %}