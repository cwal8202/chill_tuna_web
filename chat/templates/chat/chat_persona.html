{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
  <link href="{% static 'css/chat/chat.css' %}" rel="stylesheet">
{% endblock %}

{% block title %}í˜ë¥´ì†Œë‚˜ ì±„íŒ…{% endblock %}

{% block content %}
<div class="chat-wrapper" data-persona='{{ persona_json|safe }}'>

  <!-- ğŸ”¹ í˜ë¥´ì†Œë‚˜ ì •ë³´ -->
  <div class="persona-info">
    <div class="persona-header"><strong>í˜ë¥´ì†Œë‚˜{{ persona.id }} - {{ persona.name }}</strong></div>
    <div class="persona-tags">
      <dl>
        <dt>ë¼ì´í”„ìŠ¤íƒ€ì¼</dt>
        <dd>{{ persona.segment }} - {{ persona.segment_decription }}</dd>
        
        <dt>ì¸êµ¬í†µê³„</dt>
        <dd>{{ persona.age }}, {{ persona.gender }}, {{ persona.job }}</dd>

        <dt>ì¶”ê°€ì •ë³´</dt>
        <dd>{{ persona.marriage }}, {{ persona.education }}, {{ persona.region }}</dd>

        <dt>ì†Œë“/ê°€êµ¬</dt>
        <dd>ì›”ì†Œë“:{{ persona.income_month }}, {{ persona.household }}, {{ persona.income_status }}</dd>
      </dl>
    </div>
  </div>

  <!-- ğŸ”¹ ì±„íŒ… ë©”ì‹œì§€ ëª©ë¡ -->
  <!-- ì´ˆê¸° ì•ˆë‚´ ë©”ì‹œì§€ (ì ‘ê¸°/í¼ì¹˜ê¸° ê°€ëŠ¥) -->
  <div class="chat-system-msg-wrapper">
    <div class="chat-system-msg" id="system-msg">
      ì–´ë–¤ ë¹„ì¦ˆë‹ˆìŠ¤ ì‹œë®¬ë ˆì´ì…˜ì„ ì›í•˜ì‹œë‚˜ìš”?<br>
      ì‹ ì œí’ˆ, ê¸°ì¡´ì œí’ˆì— ëŒ€í•œ êµ¬ë§¤ì˜í–¥ì„ ë¬¼ì–´ë³´ì„¸ìš”.<br>
      ë˜ëŠ” ì–´ë–¤ í”„ë¡œëª¨ì…˜ì„ í–ˆì„ ë•Œ ì´ ê³ ê°ì´ êµ¬ë§¤í•  ì˜í–¥ì´ ìƒê¸¸ì§€ ë¬¼ì–´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>
    <button id="toggle-system-msg" class="toggle-btn">ì•ˆë‚´ ì ‘ê¸°</button>
  </div>
  {% for msg in chat_messages %}
    <div class="chat-row {% if msg.sender == 'user' %}user{% else %}persona{% endif %}">
      <div class="chat-bubble">{{ msg.message }}</div>
    </div>
  {% endfor %}

  <!-- ğŸ”¹ ì…ë ¥ì°½ -->
  <form class="chat-input-container">
    {% csrf_token %}
    <div class="chat-input-box">
      <input type="text" class="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
      <button type="button" class="chat-send-btn">ì „ì†¡</button>
    </div>
    <div class="chat-footer-note">
      Chill Tuna ë¹„ì¦ˆë‹ˆìŠ¤ ì‹œë®¬ë ˆì´í„°ëŠ” ì‹¤ìˆ˜ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
      ì°¸ê³ ìš©ìœ¼ë¡œ ì‚¬ìš©í•˜ì„¸ìš”.
    </div>
  </form>

</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // ì•ˆë‚´ ì ‘ê¸° ê¸°ëŠ¥
    const toggleBtn = document.getElementById("toggle-system-msg");
    const systemMsg = document.getElementById("system-msg");
    const chatWrapper = document.querySelector('.chat-wrapper');
    const personaJsonString = chatWrapper.dataset.persona;
    const persona = JSON.parse(personaJsonString);

    toggleBtn.addEventListener("click", function () {
      if (systemMsg.style.display === "none") {
        systemMsg.style.display = "block";
        toggleBtn.textContent = "ì•ˆë‚´ ì ‘ê¸°";
      } else {
        systemMsg.style.display = "none";
        toggleBtn.textContent = "ì•ˆë‚´ ë³´ê¸°";
      }
    });

    const inputBox = document.querySelector(".chat-input");
    const sendBtn = document.querySelector(".chat-send-btn");
    let isSending = false;
    let loadingInterval = null;

    // ì „ì†¡ ë²„íŠ¼ í´ë¦­ì‹œ
    sendBtn.addEventListener("click", sendMessage);

    // ì…ë ¥ ë²„íŠ¼ ì—”í„° ëˆ„ë¥¼ ë•Œ
    inputBox.addEventListener("keydown", function (event) {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    });

    // CSRF í† í° ì½ê¸° í•¨ìˆ˜
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // ì±„íŒ… ìŠ¤ë ˆë“œ id 
    let currentThreadId = {{ thread_id|default:"null" }};

    // ì‚¬ìš©ì ì…ë ¥ ê°’ ì „ì†¡ í•¨ìˆ˜
    async function sendMessage() {
      if (isSending) return;
      const message = inputBox.value.trim();
      if (!message) return;

      isSending = true;
      sendBtn.disabled = true;
      inputBox.disabled = true;
      sendBtn.textContent = "â¹ï¸";

      // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
      const userChat = document.createElement("div");
      userChat.className = "chat-row user";
      userChat.innerHTML = `<div class="chat-bubble">${message}</div>`;
      document.querySelector(".chat-input-container").before(userChat);

      // í˜ë¥´ì†Œë‚˜ ë¡œë”© ë²„ë¸” ì¶”ê°€
      const loadingChat = document.createElement("div");
      loadingChat.className = "chat-row persona loading";
      loadingChat.innerHTML = `<div class="chat-bubble">â³ ë¡œë”© ì¤‘</div>`;
      document.querySelector(".chat-input-container").before(loadingChat);

      // ë¡œë”©ì¤‘ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
      let dotCount = 0;
      loadingInterval = setInterval(() => {
        dotCount = (dotCount + 1) % 4; // 0,1,2,3 ë°˜ë³µ
        const dots = '.'.repeat(dotCount);
        loadingChat.querySelector('.chat-bubble').textContent = `â³ ë¡œë”© ì¤‘${dots}`;
      }, 500);

      try {
        const modelSelector = document.querySelector(".model-selector");
        let model = modelSelector ? modelSelector.value : "default-model";
        const personaId = {{ persona.id }};

        const response = await fetch("{% url 'chat:chat_view' persona.id thread_id %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken")
          },
          body: JSON.stringify({ message, model, persona_id: personaId, thread_id: currentThreadId })
        });
        
        const data = await response.json();

        if (data.redirect_to_home) {
            alert(data.error);
            window.location.href = '/';
            return;
        }

        // ìƒˆì±„íŒ…ì´ë©´ base.html ëª©ë¡ì— ì¶”ê°€
        if (data.is_new_thread) {
          // base.html ëª©ë¡ì— ì¶”ê°€
          const chatList = document.querySelector('.chat-list');
          const newChatItem  = document.createElement('li');
          const newUrl = `/chat/${personaId}/${data.thread_id}/`;
          newChatItem.className = 'chat-item';
          newChatItem.innerHTML = `
                              <a href="${newUrl}" class="chat-link">
                                <div class="chat-icon-circle">ğŸ’¬</div>
                                <div class="chat-info">
                                  <div class="chat-badge">${persona.persona_summary_tag}</div>
                                  <div class="chat-name">${data.thread_id} í˜ë¥´ì†Œë‚˜ ${personaId} - ${persona.name}</div>
                                </div>
                              </a>
                                `;
          // ì œì¼ ìœ„ì— ì¶”ê°€
          chatList.prepend(newChatItem); 
          // ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ì˜ URLì„ ìƒˆë¡œê³ ì¹¨ ì—†ì´ ë³€ê²½í•©ë‹ˆë‹¤.
          const newUrlForHistory = `/chat/${personaId}/${data.thread_id}/`;
          history.replaceState(null, '', newUrlForHistory);

        }
        
        // ìƒˆë¡œ ìƒì„±ëœ thread_id ì „ë‹¬
        if (data.thread_id) {
            currentThreadId = data.thread_id;
        }

        // ë¡œë”©ì¤‘ ì •ì§€
        clearInterval(loadingInterval);

        // ë¡œë”©ì¤‘ ì‹¤ì œ ì‘ë‹µìœ¼ë¡œ êµì²´
        const personaChat = document.createElement("div");
        personaChat.className = "chat-row persona";
        personaChat.innerHTML = `<div class="chat-bubble">${data.persona_msg}</div>`;
        loadingChat.replaceWith(personaChat);

        inputBox.value = "";
      } catch (err) {
        console.error("ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì—ëŸ¬:", err);
        clearInterval(loadingInterval);
        loadingChat.querySelector('.chat-bubble').textContent = `â— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`;
      } finally {
        isSending = false;
        sendBtn.disabled = false;
        inputBox.disabled = false;
        sendBtn.textContent = "ğŸ“¤";
        inputBox.focus();
      }
    }
  });
</script>


{% endblock %}
