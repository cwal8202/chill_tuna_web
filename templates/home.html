{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
  {# í™ˆ ê¸°ë³¸ ìŠ¤íƒ€ì¼ #}
  <link href="{% static 'css/home/home.css' %}" rel="stylesheet">
  {# ì‹¤ì œ ì±„íŒ…ê³¼ ë™ì¼í•œ ë£©&í•„ì„ ìœ„í•´ chat.cssë„ í•¨ê»˜ ë¡œë“œ #}
  <link href="{% static 'css/chat/chat.css' %}" rel="stylesheet">

  <style>
    /* ===== ì‹¤ì œ ìƒ‰/ë²„ë¸” ìŠ¤íƒ€ì¼ì€ chat.cssë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© ===== */

    /* ë°ëª¨ ë˜í•‘ ì¹´ë“œ í¬ê¸°(ì „ì²´ ì¹´ë“œ í­) */
    .home-demo-wrap {
      width: 100%;
      max-width: 1100px;
      margin: 28px auto 0;
      box-sizing: border-box;
    }

    .home-demo-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.06);
      overflow: hidden;
    }

    .home-demo-header {
      display: flex; align-items: center; gap: 10px;
      padding: 12px 16px; background: #fafafa; border-bottom: 1px solid #f3f4f6;
      font-weight: 700; color: #111827;
    }

    /* ìŠ¤í¬ë¡¤ ì˜ì—­ì€ ì¤‘ì•™ ì •ë ¬ ì»¨í…Œì´ë„ˆ ì—­í• ë§Œ */
    .home-demo-scroll {
      height: 700px;
      padding: 20px;
      background: #fff;
      overflow-y: auto;
      overflow-x: hidden;                 /* ì¢Œìš° ìŠ¤í¬ë¡¤ ë°©ì§€ */
      scroll-behavior: smooth;

      display: flex;                      /* ì¤‘ì•™ì— ê³ ì • */
      justify-content: center;
    }

    /* âœ… ë©”ì‹œì§€ ì»¬ëŸ¼(ì‹¤ì œ ì±„íŒ…ê³¼ ë™ì¼í•œ ê¸°ì¤€ í­) */
    .home-demo-scroll .chat-wrapper {
      width: 100%;
      max-width: 720px;                   /* chat.cssì™€ ë™ì¼ */
      margin: 0;                          /* ì¹´ë“œ ì•ˆì—ì„œëŠ” ë°”ê¹¥ ì—¬ë°± ì œê±° */
      background-color: #f9fafb;          /* chat.css ìœ ì§€ */
      padding: 40px;
      border-radius: 20px;
      display: flex; flex-direction: column; gap: 20px;

      box-sizing: border-box;
      overflow-x: hidden;                 /* ë‚´ë¶€ ìš”ì†Œê°€ ë°€ì–´ë‚´ëŠ” ê²ƒ ë°©ì§€ */
    }

    /* âœ… ì–´ë–¤ ë‚´ìš©ë„ ê°€ë¡œë¥¼ ë°€ì§€ ëª»í•˜ê²Œ: ê°•ì œ ì¤„ë°”ê¿ˆ ê·œì¹™ ì¶”ê°€ */
    .chat-row { width: 100%; max-width: 100%; min-width: 0; }
    .chat-bubble {
      max-width: 70%;                     /* chat.cssì™€ ë™ì¼ */
      min-width: 0;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: anywhere;            /* ê¸´ í† í°/URLë„ ê°•ì œ ì¤„ë°”ê¿ˆ */
      box-sizing: border-box;
    }

    /* ìƒë‹¨ ì¹´ë“œ/ì•ˆë‚´ë„ ì•ˆì „í•˜ê²Œ ì¤„ë°”ê¿ˆ */
    .persona-info, .persona-tags, .chat-system-msg {
      white-space: normal;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    /* ë§í¬/ì½”ë“œ/ë¯¸ë””ì–´ê°€ í­ì„ ë°€ì§€ ì•Šë„ë¡ */
    .chat-bubble a { word-break: break-all; }
    .chat-bubble img,
    .chat-bubble video,
    .chat-bubble pre,
    .chat-bubble code {
      max-width: 100%;
      display: block;
    }

    /* ì ‘ê·¼ì„±: ëª¨ì…˜ ìµœì†Œí™” */
    @media (prefers-reduced-motion: reduce) {
      .home-demo-scroll { scroll-behavior: auto; }
    }
    .chat-bubble {
      text-align: left;
    }
    .home-demo-card,
    .home-demo-card * {
      text-align: left;
    }

    .home-demo-card .chat-bubble,
    .home-demo-card .persona-info,
    .home-demo-card .persona-header,
    .home-demo-card .persona-tags,
    .home-demo-card .chat-system-msg,
    .home-demo-card .chat-system-msg-wrapper {
      text-align: left;
    }

    .home-description {
      max-width: 700px;
      margin: 20px auto;
    }
  </style>
{% endblock %}

{% block title %}Home - Chill Tuna{% endblock %}

{% block content %}
  <div class="home-container">
    <h1 class="home-slogan">ë‹¹ì‹ ë§Œì„ ìœ„í•œ AI í˜ë¥´ì†Œë‚˜ì™€ ëŒ€í™”í•˜ì„¸ìš”.</h1>
    <p class="home-description">Chill TunaëŠ” ë‹¤ì–‘í•œ í˜ë¥´ì†Œë‚˜ì™€ ê¹Šì´ ìˆëŠ” ëŒ€í™”ë¥¼ ë‚˜ëˆŒ ìˆ˜ ìˆëŠ” AI ì±—ë´‡ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</p>

    {% if user.is_authenticated %}
      <a href="{% url 'persona:create_persona' %}" class="cta-button">ìƒˆ ì±„íŒ… ì‹œì‘í•˜ê¸°</a>
      <p class="welcome-message">ì•ˆë…•í•˜ì„¸ìš”, {{ user.username }}ë‹˜!</p>
    {% else %}
      <a href="{% url 'users:login' %}" class="cta-button">ë¡œê·¸ì¸í•˜ì—¬ ì‹œì‘í•˜ê¸°</a>
      <p class="auth-prompt">ì•„ì§ ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <a href="{% url 'users:signup' %}">íšŒì›ê°€ì…</a></p>
    {% endif %}

    <!-- ğŸ”¥ ì‹¤ì œ chat.css ë£©&í•„ì„ ê·¸ëŒ€ë¡œ ì“°ëŠ” í™ˆ ë°ëª¨ -->
    <div class="home-demo-wrap">
      <div class="home-demo-card">
        <div class="home-demo-header">Chill Tuna ë°ëª¨</div>

        <!-- ì‹¤ì œ ì±„íŒ…ê³¼ ê°™ì€ ë˜í¼/í–‰/ë²„ë¸” í´ë˜ìŠ¤ êµ¬ì¡° -->
        <div id="demoScroll" class="home-demo-scroll">
          <div class="chat-wrapper" aria-live="polite" aria-atomic="false">
            <!-- (JSê°€ ì•„ë˜ì— ë©”ì‹œì§€ë¥¼ ì£¼ì…) -->
            <div class="persona-info" style="margin-bottom:12px;">
              <div class="persona-header"><strong>í˜ë¥´ì†Œë‚˜1123 - ì†¡ë™í›ˆ</strong></div>
              <div class="persona-tags">
                <div>íŠ¸ë Œë“œ ì£¼ë„í˜• ì†Œë¹„ì</div>
                <div>50ëŒ€, ë‚¨ì, ê¸°ëŠ¥ ë° ê´€ë ¨ ê¸°ëŠ¥ ì¢…ì‚¬ì</div>
                <div>ê´‘ì£¼ê´‘ì—­ì‹œ, 1ì¸ ê°€êµ¬, ì›”ì†Œë“ 200~300ë§Œì› ë¯¸ë§Œ</div>
              </div>
            </div>

            <div class="chat-system-msg-wrapper" style="margin-bottom:12px;">
              <div class="chat-system-msg">
                ì–´ë–¤ ë¹„ì¦ˆë‹ˆìŠ¤ ì‹œë®¬ë ˆì´ì…˜ì„ ì›í•˜ì‹œë‚˜ìš”?<br>
                ì‹ ì œí’ˆ, ê¸°ì¡´ì œí’ˆì— ëŒ€í•œ êµ¬ë§¤ì˜í–¥ì„ ë¬¼ì–´ë³´ì„¸ìš”.<br>
                ë˜ëŠ” ì–´ë–¤ í”„ë¡œëª¨ì…˜ì„ í–ˆì„ ë•Œ ì´ ê³ ê°ì´ êµ¬ë§¤í•  ì˜í–¥ì´ ìƒê¸¸ì§€ ë¬¼ì–´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </div>
              <button class="toggle-btn" type="button" disabled>ì•ˆë‚´ ì ‘ê¸°</button>
            </div>

            <!-- âœ… ì‹¤ì œ ì±„íŒ…ê³¼ ë™ì¼í•œ ì…ë ¥ì°½ êµ¬ì¡° (ë¹„í™œì„±í™”) -->
            <form class="chat-input-container">
              <div class="chat-input-box">
                <input type="text" class="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." disabled>
                <button type="button" class="chat-send-btn" disabled>ì „ì†¡</button>
              </div>
              <div class="chat-footer-note">
                Chill Tuna ë¹„ì¦ˆë‹ˆìŠ¤ ì‹œë®¬ë ˆì´í„°ëŠ” ì‹¤ìˆ˜ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                ì°¸ê³ ìš©ìœ¼ë¡œ ì‚¬ìš©í•˜ì„¸ìš”.
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# JS: ìë™ íƒ€ì´í•‘ ë°ëª¨ â€” ì‹¤ì œ chat.html í´ë˜ìŠ¤ ì¬ì‚¬ìš© #}
  <script>
    // ë°ëª¨ ì‹œë‚˜ë¦¬ì˜¤ (ì›í•˜ëŠ” ë¬¸ì¥ìœ¼ë¡œ ë°”ê¿”ë„ ë¨)
    const DEMO_DIALOG = [
      { role: 'user',    text: 'ë„ˆëŠ” ì–´ë–¤ ì†Œë¹„ìì•¼?' },
      { role: 'persona', text: 'ì €ëŠ” ê´‘ì£¼ì— ì‚¬ëŠ” 50ëŒ€ ë‚¨ì 1ì¸ ê°€êµ¬ì˜ ì†¡ë™í›ˆì´ê³ , í¸ì˜ë¥¼ íŠ¹íˆ ì¤‘ì‹œí•˜ê³  ê°€ê²©ì—ë„ ë¯¼ê°í•œ í¸ì´ì—ìš”.'},
      { role: 'user',    text: 'ê·¸ëŸ¼ ë‹¹ì‹ ì€ ì–´ë–¤ ì‹í’ˆì„ ì„ í˜¸í•˜ë‚˜ìš”?' },
      { role: 'persona', text: 'ì €ëŠ” ê±´ê°•í•˜ê³  ê°„í¸í•œ HMR(ì¦‰ì„ì‹í’ˆ)ê³¼ í”„ë¦¬ë¯¸ì—„ ì œí’ˆì„ ì„ í˜¸í•´ìš”. ìƒˆë¡œìš´ ë§›ê³¼ ê²½í—˜ì„ ì¤‘ì‹œí•˜ê³ , ìš”ë¦¬ë¥¼ ìì£¼ í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ê°„í¸í•˜ê²Œ ë¨¹ì„ ìˆ˜ ìˆëŠ” ì œí’ˆì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤.' },
    ];

    const scrollArea = document.getElementById('demoScroll');
    const wrapper    = scrollArea.querySelector('.chat-wrapper');

    // ìœ í‹¸
    function el(tag, cls) { const n = document.createElement(tag); if (cls) n.className = cls; return n; }
    function scrollToBottom() { scrollArea.scrollTop = scrollArea.scrollHeight; }

    function appendRow(role, text) {
      const row = el('div', `chat-row ${role === 'user' ? 'user' : 'persona'}`);
      const bubble = el('div', 'chat-bubble');
      bubble.textContent = text || '';
      row.appendChild(bubble);
      // ì…ë ¥ì°½(form) ì•ì—ë§Œ ë©”ì‹œì§€ë¥¼ ì‚½ì…í•´ì„œ ì…ë ¥ì°½ì´ í•­ìƒ ë§¨ ì•„ë˜ì— ìœ ì§€ë˜ë„ë¡
      const inputForm = wrapper.querySelector('.chat-input-container');
      wrapper.insertBefore(row, inputForm);
      scrollToBottom();
      return bubble;
    }

    // ì‹¤ì œ ì±„íŒ…ì—ì„œ ì“°ëŠ” ë¡œë”© ë²„ë¸” ìŠ¤íƒ€ì¼ì„ í‰ë‚´ (chat.cssì˜ .chat-row.persona.loadingê³¼ ì‹œê° í†¤ì„ ì¼ì¹˜)
    function appendLoadingRow() {
      const row = el('div', 'chat-row persona loading');
      const bubble = el('div', 'chat-bubble');
      bubble.textContent = 'â³ ë¡œë”© ì¤‘';
      row.appendChild(bubble);
      const inputForm = wrapper.querySelector('.chat-input-container');
      wrapper.insertBefore(row, inputForm);
      scrollToBottom();

      // ì ì ì  ì• ë‹ˆë©”ì´ì…˜
      let dot = 0;
      const id = setInterval(() => {
        dot = (dot + 1) % 4;
        bubble.textContent = 'â³ ë¡œë”© ì¤‘' + '.'.repeat(dot);
      }, 500);

      return { row, stop: () => clearInterval(id) };
    }

    async function typeText(node, text, speed = 14) {
      const reduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (reduced) { node.textContent = text; scrollToBottom(); return; }

      node.textContent = '';
      for (let i = 0; i < text.length; i++) {
        node.textContent += text[i];
        if (i % 3 === 0) scrollToBottom();
        await new Promise(r => setTimeout(r, speed));
      }
    }

    async function playDemoOnce() {
      for (const msg of DEMO_DIALOG) {
        if (msg.role === 'persona') {
          const loader = appendLoadingRow();
          await new Promise(r => setTimeout(r, 420));
          loader.stop();
          loader.row.remove();

          const bubble = appendRow('persona', '');
          await typeText(bubble, msg.text);
        } else {
          const bubble = appendRow('user', '');
          await typeText(bubble, msg.text);
        }
        await new Promise(r => setTimeout(r, 360));
      }
    }

    async function loopDemo() {
      while (true) {
        // persona-info/ì•ˆë‚´/ì…ë ¥ì°½ì€ ìœ ì§€, ë©”ì‹œì§€ í–‰ë“¤ë§Œ ì§€ìš°ê¸°
        const keep = new Set(wrapper.querySelectorAll('.persona-info, .chat-system-msg-wrapper, .chat-input-container'));
        [...wrapper.children].forEach(node => { if (!keep.has(node)) node.remove(); });

        await playDemoOnce();
        await new Promise(r => setTimeout(r, 1400));
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      playDemoOnce().catch(console.error);
      // loopDemo().catch(console.error); ìë™ ë°˜ë³µ í•˜ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©
    });
  </script>
{% endblock %}
