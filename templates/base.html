{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}Chill Tuna - í˜ë¥´ì†Œë‚˜{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="{% static 'img/brand.png' %}" rel="icon">
  <link href="{% static 'css/base.css' %}" rel="stylesheet">
  {% block extra_head %}{% endblock %}
</head>
<body>
  
  <div class="layout">
    
    <!-- âœ… ì‚¬ì´ë“œë°” -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="{% url 'home' %}" class="logo-link" style="display: flex; align-items: center;">
          <img src="{% static 'img/logo.png' %}" alt="Chill Tuna Logo" class="logo-img">
          <span class="logo-text">Chill Tuna</span>
        </a>
      </div>

      <div class="sidebar-title">My Chatbots</div>
      <button class="sidebar-btn" data-url="{% url 'persona:create_persona' %}" onclick="location.href='{% url 'persona:create_persona' %}'"><img src="{% static 'img/chat.png' %}" alt="ìƒˆ ì±„íŒ…" class="sidebar-btn-img"> ìƒˆ ì±„íŒ…</button>
      <button class="sidebar-btn" id="open-search-modal-btn"><img src="{% static 'img/search.png' %}" alt="ì±„íŒ… ê²€ìƒ‰" class="sidebar-btn-img"> ì±„íŒ… ê²€ìƒ‰</button>
      <button class="sidebar-btn" data-url="{% url 'chat:all_chats' %}" onclick="location.href='{% url 'chat:all_chats' %}'"><img src="{% static 'img/all_chat.png' %}" alt="ëª¨ë“  ì±„íŒ… ë³´ê¸°" class="sidebar-btn-img"> ëª¨ë“  ì±„íŒ… ë³´ê¸°</button>

      <hr class="divider">

      <div class="recent-section">
        <div class="recent-title">Recent Chats</div>
        <ul class="chat-list">
          {% for chat_thread in recent_chats %}
          <li class="chat-item">
            <a href="{% url 'chat:chat_view' chat_thread.persona.id chat_thread.id %}" class="chat-link">
              <div class="chat-icon-circle">ğŸ’¬</div>
              <div class="chat-info">
                <div class="chat-name">{{ chat_thread.persona.name }}</div>
                <div class="chat-badges-container">
                  <div class="chat-badge">{{ chat_thread.persona.segment }}</div>
                  <div class="chat-badge">{{ chat_thread.persona.age }}</div>
                  <div class="chat-badge">{{ chat_thread.persona.household }}</div>
                  <div class="chat-badge">{{ chat_thread.persona.job }}</div>
                </div>
              </div>
            </a>
            <button class="delete-chat-btn" data-thread-id="{{ chat_thread.id }}">ì‚­ì œ</button>
          </li>
          {% empty %}
          <li class="chat-item no-chats">ìµœê·¼ ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤.</li>
          {% endfor %}
        </ul>
      </div>
    </aside>

    <!-- âœ… ë©”ì¸ ì½˜í…ì¸  -->
    <main class="main-content">

      <!-- ë³¸ë¬¸ í—¤ë” -->
      <div class="main-header">
        <select class="model-selector">
          <option>gpt-5-mini</option>
          <option>gpt-4o-mini</option>
        </select>
        <div class="user-auth">
          {% if user.is_authenticated %}
            <span>ì•ˆë…•í•˜ì„¸ìš”, {{ user.username }}ë‹˜!</span>
            <form action="{% url 'users:logout' %}" method="post" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
            </form>
          {% else %}
            <a href="{% url 'users:login' %}">ë¡œê·¸ì¸</a>
            <a href="{% url 'users:signup' %}">íšŒì›ê°€ì…</a>
          {% endif %}
        </div>
      </div>

      <!-- ë³¸ë¬¸ ì¹´ë“œ -->
      <div class="card">
        {% block content %}{% endblock %}
      </div>

    </main>
  </div>

  <!-- Search Modal Structure -->
  <div id="searchModal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>ì±„íŒ… ê²€ìƒ‰</h2>
      <div class="modal-search-input-container">
        <input type="text" id="modal-search-input" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
        <button id="modal-search-btn">ê²€ìƒ‰</button>
      </div>
      <div id="search-results-display">
        <!-- Search results will be loaded here -->
      </div>
    </div>
  </div>

</body>
<script>
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 1) ì „ì—­(App) ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— í•¨ìˆ˜ ë…¸ì¶œ + IIFEë¡œ ìŠ¤ì½”í”„ ë³´í˜¸
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (function () {
    // CSRF í† í°ì„ ì¿ í‚¤ì—ì„œ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ëŠ” í—¬í¼
    function getCsrfToken() {
      const name = 'csrftoken';
      const cookies = document.cookie ? document.cookie.split('; ') : [];
      for (let i = 0; i < cookies.length; i++) {
        const parts = cookies[i].split('=');
        const key = decodeURIComponent(parts[0]);
        if (key === name) {
          return decodeURIComponent(parts.slice(1).join('='));
        }
      }
      // í¼ì— hidden inputì´ ìˆëŠ” ê²½ìš° ëŒ€ë¹„(ì—†ìœ¼ë©´ null)
      const input = document.querySelector('[name=csrfmiddlewaretoken]');
      return input ? input.value : null;
    }

    // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ë¥¼ í•œë²ˆë§Œ ìœ„ì„ ë°”ì¸ë”©
    function addDeleteEventListeners() {
      if (window.App?._deleteInitDone) return; // ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€

      document.addEventListener('click', async function (e) {
        const btn = e.target.closest('.delete-chat-btn');
        if (!btn) return;

        e.preventDefault();

        const threadId = btn.dataset.threadId;
        if (!threadId) return;

        if (!confirm('ì •ë§ë¡œ ì´ ì±„íŒ…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        const csrftoken = getCsrfToken();
        if (!csrftoken) {
          alert('CSRF í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          return;
        }

        try {
          const res = await fetch(`/chat/thread/${threadId}/delete/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrftoken,
              'Content-Type': 'application/json',
            },
          });
          const data = await res.json();

          if (data.status === 'success') {
            const currentPath = window.location.pathname;
            const parts = currentPath.split('/').filter(Boolean);
            if (parts.length === 3 && parts[0] === 'chat' && parts[2] === threadId) {
              window.location.href = '/';
            } else {
              const li = btn.closest('li.chat-item, li.chat-card');
              if (li) li.remove();
            }
          } else {
            alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          }
        } catch (err) {
          console.error(err);
          alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      }, { passive: true });

      window.App = window.App || {};
      window.App._deleteInitDone = true;
    }

    // í•„ìš”í•œ ê²ƒë§Œ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
    window.App = window.App || {};
    window.App.addDeleteEventListeners = addDeleteEventListeners;
  })();

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 2) í˜ì´ì§€ ê³µí†µ ì´ˆê¸°í™” (ëª¨ë‹¬ + ì‚­ì œ ë¦¬ìŠ¤ë„ˆ ì‹¤í–‰)
  //    â€» addDeleteEventListenersëŠ” baseì—ì„œ í•œ ë²ˆë§Œ ì‹¤í–‰í•˜ë©´ ë¨
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.addEventListener("DOMContentLoaded", function () {
    // ===== ì‚¬ì´ë“œë°” í™œì„±í™” í•¨ìˆ˜ =====
    function updateSidebar() {
      const currentPath = window.location.pathname;
      const sidebarButtons = document.querySelectorAll(".sidebar-btn");

      // ë¨¼ì € ëª¨ë“  ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
      sidebarButtons.forEach(button => {
        button.classList.remove("active");
      });

      // í˜„ì¬ ê²½ë¡œì™€ ì¼ì¹˜í•˜ëŠ” ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
      sidebarButtons.forEach(button => {
        const buttonUrl = button.getAttribute('data-url');
        if (buttonUrl && currentPath === buttonUrl) {
          button.classList.add("active");
        }
      });
    }

    // ===== ëª¨ë‹¬ ê´€ë¦¬ í•¨ìˆ˜ =====
    function closeModal() {
      const searchModal = document.getElementById("searchModal");
      const searchResultsDisplay = document.getElementById("search-results-display");
      const modalSearchInput = document.getElementById("modal-search-input");

      searchModal.style.display = "none";
      searchResultsDisplay.innerHTML = '';
      modalSearchInput.value = '';
      
      // ëª¨ë‹¬ì´ ë‹«í ë•Œ ì‚¬ì´ë“œë°” ìƒíƒœë¥¼ í˜„ì¬ URL ê¸°ì¤€ìœ¼ë¡œ ë‹¤ì‹œ ì—…ë°ì´íŠ¸
      updateSidebar();
    }

    // ===== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë°”ì¸ë”© =====

    // --- ëª¨ë‹¬ ì—´ê¸° ë²„íŠ¼ ---
    const openSearchModalBtn = document.getElementById("open-search-modal-btn");
    if (openSearchModalBtn) {
      openSearchModalBtn.addEventListener("click", function () {
        // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™” í›„, ê²€ìƒ‰ ë²„íŠ¼ë§Œ í™œì„±í™”
        document.querySelectorAll(".sidebar-btn").forEach(btn => btn.classList.remove("active"));
        this.classList.add("active");
        
        const searchModal = document.getElementById("searchModal");
        searchModal.style.display = "flex";
      });
    }

    // --- ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ ---
    const closeButton = document.querySelector(".close-button");
    if (closeButton) {
      closeButton.addEventListener("click", closeModal);
    }

    // --- ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ---
    window.addEventListener("click", function (event) {
      const searchModal = document.getElementById("searchModal");
      if (event.target == searchModal) {
        closeModal();
      }
    });

    // --- ëª¨ë‹¬ ë‚´ ê²€ìƒ‰ ê¸°ëŠ¥ ---
    const modalSearchInput = document.getElementById("modal-search-input");
    const modalSearchBtn = document.getElementById("modal-search-btn");
    if (modalSearchBtn) {
      modalSearchBtn.addEventListener("click", performModalSearch);
      modalSearchInput.addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
          event.preventDefault();
          performModalSearch();
        }
      });
    }

    async function performModalSearch() {
      {% if not user.is_authenticated %}
        document.getElementById("search-results-display").innerHTML = '<p>ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.</p>';
        return;
      {% endif %}

      const query = modalSearchInput.value.trim();
      const searchResultsDisplay = document.getElementById("search-results-display");
      if (!query) {
        searchResultsDisplay.innerHTML = '<p>ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>';
        return;
      }
      searchResultsDisplay.innerHTML = '<p>ê²€ìƒ‰ ì¤‘...</p>';
      try {
        const response = await fetch(`{% url 'chat:chat_search' %}?q=${encodeURIComponent(query)}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();

        if (data.error) {
          searchResultsDisplay.innerHTML = `<p style="color: red;">ì˜¤ë¥˜: ${data.error}</p>`;
          return;
        }

        if (data.results && data.results.length > 0) {
          let resultsHtml = '<ul class="search-results-list-modal">';
          data.results.forEach(thread => {
            resultsHtml += `<li class="search-result-item-modal">
              <a href="/chat/${thread.persona_id}/${thread.thread_id}/" class="search-result-link-modal">
                <div class="search-result-header-modal">
                  <span class="search-result-persona-modal">${thread.persona_name}</span>
                  <span class="search-result-date-modal">${thread.last_message_date}</span>
                </div>
                <div class="search-result-thread-title-modal">ì±„íŒ… ìŠ¤ë ˆë“œ ID: ${thread.thread_id}</div>
                <ul class="search-result-messages-modal">
                  ${thread.messages.map(msg => `<li><span class="search-result-sender-modal">(${msg.sender})</span> ${msg.message}</li>`).join('')}
                </ul>
              </a>
            </li>`;
          });
          resultsHtml += '</ul>';
          searchResultsDisplay.innerHTML = resultsHtml;
        } else {
          searchResultsDisplay.innerHTML = '<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
      } catch (error) {
        console.error("Search failed:", error);
        searchResultsDisplay.innerHTML = `<p style="color: red;">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
      }
    }

    // --- ì±„íŒ… ì‚­ì œ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™” ---
    if (window.App?.addDeleteEventListeners) {
      window.App.addDeleteEventListeners();
    }
    
    // --- í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ì´ë“œë°” ìƒíƒœ ìµœì¢… ì—…ë°ì´íŠ¸ ---
    updateSidebar();
  });
</script>
</html>