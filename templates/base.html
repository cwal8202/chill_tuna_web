{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}Chill Tuna - 페르소나{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="{% static 'img/brand.png' %}" rel="icon">
  <link href="{% static 'css/base.css' %}" rel="stylesheet">
  {% block extra_head %}{% endblock %}
</head>
<body>
  
  <div class="layout">
    
    <!-- ✅ 사이드바 -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="{% url 'home' %}" class="logo-link" style="display: flex; align-items: center;">
          <img src="{% static 'img/logo.png' %}" alt="Chill Tuna Logo" class="logo-img">
          <span class="logo-text">Chill Tuna</span>
        </a>
      </div>

      <div class="sidebar-title">My Chatbots</div>
      <button class="sidebar-btn" data-url="{% url 'persona:create_persona' %}" onclick="location.href='{% url 'persona:create_persona' %}'"><img src="{% static 'img/chat.png' %}" alt="새 채팅" class="sidebar-btn-img"> 새 채팅</button>
      <button class="sidebar-btn" id="open-search-modal-btn"><img src="{% static 'img/search.png' %}" alt="채팅 검색" class="sidebar-btn-img"> 채팅 검색</button>
      <button class="sidebar-btn" data-url="{% url 'chat:all_chats' %}" onclick="location.href='{% url 'chat:all_chats' %}'"><img src="{% static 'img/all_chat.png' %}" alt="모든 채팅 보기" class="sidebar-btn-img"> 모든 채팅 보기</button>

      <hr class="divider">

      <div class="recent-section">
        <div class="recent-title">Recent Chats</div>
        <ul class="chat-list">
          {% for chat_thread in recent_chats %}
          <li class="chat-item">
            <a href="{% url 'chat:chat_view' chat_thread.persona.id chat_thread.id %}" class="chat-link">
              <div class="chat-icon-circle">💬</div>
              <div class="chat-info">
                <div class="chat-name">{{ chat_thread.persona.name }}</div>
                <div class="chat-badges-container">
                  <div class="chat-badge">{{ chat_thread.persona.segment }}</div>
                  <div class="chat-badge">{{ chat_thread.persona.age }}</div>
                  <div class="chat-badge">{{ chat_thread.persona.household }}</div>
                  <div class="chat-badge">{{ chat_thread.persona.job }}</div>
                </div>
              </div>
            </a>
            <button class="delete-chat-btn" data-thread-id="{{ chat_thread.id }}">삭제</button>
          </li>
          {% empty %}
          <li class="chat-item no-chats">최근 채팅이 없습니다.</li>
          {% endfor %}
        </ul>
      </div>
    </aside>

    <!-- ✅ 메인 콘텐츠 -->
    <main class="main-content">

      <!-- 본문 헤더 -->
      <div class="main-header">
        <select class="model-selector">
          <option>gpt-5-mini</option>
          <option>gpt-4o-mini</option>
        </select>
        <div class="user-auth">
          {% if user.is_authenticated %}
            <span>안녕하세요, {{ user.username }}님!</span>
            <form action="{% url 'users:logout' %}" method="post" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="logout-btn">로그아웃</button>
            </form>
          {% else %}
            <a href="{% url 'users:login' %}">로그인</a>
            <a href="{% url 'users:signup' %}">회원가입</a>
          {% endif %}
        </div>
      </div>

      <!-- 본문 카드 -->
      <div class="card">
        {% block content %}{% endblock %}
      </div>

    </main>
  </div>

  <!-- Search Modal Structure -->
  <div id="searchModal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>채팅 검색</h2>
      <div class="modal-search-input-container">
        <input type="text" id="modal-search-input" placeholder="검색어를 입력하세요...">
        <button id="modal-search-btn">검색</button>
      </div>
      <div id="search-results-display">
        <!-- Search results will be loaded here -->
      </div>
    </div>
  </div>

</body>
<script>
  // ─────────────────────────────────────────────────────────────
  // 1) 전역(App) 네임스페이스에 함수 노출 + IIFE로 스코프 보호
  // ─────────────────────────────────────────────────────────────
  (function () {
    // CSRF 토큰을 쿠키에서 안전하게 가져오는 헬퍼
    function getCsrfToken() {
      const name = 'csrftoken';
      const cookies = document.cookie ? document.cookie.split('; ') : [];
      for (let i = 0; i < cookies.length; i++) {
        const parts = cookies[i].split('=');
        const key = decodeURIComponent(parts[0]);
        if (key === name) {
          return decodeURIComponent(parts.slice(1).join('='));
        }
      }
      // 폼에 hidden input이 있는 경우 대비(없으면 null)
      const input = document.querySelector('[name=csrfmiddlewaretoken]');
      return input ? input.value : null;
    }

    // 삭제 버튼 이벤트를 한번만 위임 바인딩
    function addDeleteEventListeners() {
      if (window.App?._deleteInitDone) return; // 중복 바인딩 방지

      document.addEventListener('click', async function (e) {
        const btn = e.target.closest('.delete-chat-btn');
        if (!btn) return;

        e.preventDefault();

        const threadId = btn.dataset.threadId;
        if (!threadId) return;

        if (!confirm('정말로 이 채팅을 삭제하시겠습니까?')) return;

        const csrftoken = getCsrfToken();
        if (!csrftoken) {
          alert('CSRF 토큰을 찾을 수 없습니다. 새로고침 후 다시 시도해주세요.');
          return;
        }

        try {
          const res = await fetch(`/chat/thread/${threadId}/delete/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrftoken,
              'Content-Type': 'application/json',
            },
          });
          const data = await res.json();

          if (data.status === 'success') {
            const currentPath = window.location.pathname;
            const parts = currentPath.split('/').filter(Boolean);
            if (parts.length === 3 && parts[0] === 'chat' && parts[2] === threadId) {
              window.location.href = '/';
            } else {
              const li = btn.closest('li.chat-item, li.chat-card');
              if (li) li.remove();
            }
          } else {
            alert('삭제에 실패했습니다: ' + (data.message || '알 수 없는 오류'));
          }
        } catch (err) {
          console.error(err);
          alert('삭제 중 오류가 발생했습니다.');
        }
      }, { passive: true });

      window.App = window.App || {};
      window.App._deleteInitDone = true;
    }

    // 필요한 것만 전역으로 노출
    window.App = window.App || {};
    window.App.addDeleteEventListeners = addDeleteEventListeners;
  })();

  // ─────────────────────────────────────────────────────────────
  // 2) 페이지 공통 초기화 (모달 + 삭제 리스너 실행)
  //    ※ addDeleteEventListeners는 base에서 한 번만 실행하면 됨
  // ─────────────────────────────────────────────────────────────
  document.addEventListener("DOMContentLoaded", function () {
    // ===== 사이드바 활성화 함수 =====
    function updateSidebar() {
      const currentPath = window.location.pathname;
      const sidebarButtons = document.querySelectorAll(".sidebar-btn");

      // 먼저 모든 버튼에서 active 클래스 제거
      sidebarButtons.forEach(button => {
        button.classList.remove("active");
      });

      // 현재 경로와 일치하는 버튼에 active 클래스 추가
      sidebarButtons.forEach(button => {
        const buttonUrl = button.getAttribute('data-url');
        if (buttonUrl && currentPath === buttonUrl) {
          button.classList.add("active");
        }
      });
    }

    // ===== 모달 관리 함수 =====
    function closeModal() {
      const searchModal = document.getElementById("searchModal");
      const searchResultsDisplay = document.getElementById("search-results-display");
      const modalSearchInput = document.getElementById("modal-search-input");

      searchModal.style.display = "none";
      searchResultsDisplay.innerHTML = '';
      modalSearchInput.value = '';
      
      // 모달이 닫힐 때 사이드바 상태를 현재 URL 기준으로 다시 업데이트
      updateSidebar();
    }

    // ===== 이벤트 리스너 바인딩 =====

    // --- 모달 열기 버튼 ---
    const openSearchModalBtn = document.getElementById("open-search-modal-btn");
    if (openSearchModalBtn) {
      openSearchModalBtn.addEventListener("click", function () {
        // 모든 버튼 비활성화 후, 검색 버튼만 활성화
        document.querySelectorAll(".sidebar-btn").forEach(btn => btn.classList.remove("active"));
        this.classList.add("active");
        
        const searchModal = document.getElementById("searchModal");
        searchModal.style.display = "flex";
      });
    }

    // --- 모달 닫기 버튼 ---
    const closeButton = document.querySelector(".close-button");
    if (closeButton) {
      closeButton.addEventListener("click", closeModal);
    }

    // --- 모달 외부 클릭 ---
    window.addEventListener("click", function (event) {
      const searchModal = document.getElementById("searchModal");
      if (event.target == searchModal) {
        closeModal();
      }
    });

    // --- 모달 내 검색 기능 ---
    const modalSearchInput = document.getElementById("modal-search-input");
    const modalSearchBtn = document.getElementById("modal-search-btn");
    if (modalSearchBtn) {
      modalSearchBtn.addEventListener("click", performModalSearch);
      modalSearchInput.addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
          event.preventDefault();
          performModalSearch();
        }
      });
    }

    async function performModalSearch() {
      {% if not user.is_authenticated %}
        document.getElementById("search-results-display").innerHTML = '<p>로그인이 필요한 기능입니다.</p>';
        return;
      {% endif %}

      const query = modalSearchInput.value.trim();
      const searchResultsDisplay = document.getElementById("search-results-display");
      if (!query) {
        searchResultsDisplay.innerHTML = '<p>검색어를 입력해주세요.</p>';
        return;
      }
      searchResultsDisplay.innerHTML = '<p>검색 중...</p>';
      try {
        const response = await fetch(`{% url 'chat:chat_search' %}?q=${encodeURIComponent(query)}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();

        if (data.error) {
          searchResultsDisplay.innerHTML = `<p style="color: red;">오류: ${data.error}</p>`;
          return;
        }

        if (data.results && data.results.length > 0) {
          let resultsHtml = '<ul class="search-results-list-modal">';
          data.results.forEach(thread => {
            resultsHtml += `<li class="search-result-item-modal">
              <a href="/chat/${thread.persona_id}/${thread.thread_id}/" class="search-result-link-modal">
                <div class="search-result-header-modal">
                  <span class="search-result-persona-modal">${thread.persona_name}</span>
                  <span class="search-result-date-modal">${thread.last_message_date}</span>
                </div>
                <div class="search-result-thread-title-modal">채팅 스레드 ID: ${thread.thread_id}</div>
                <ul class="search-result-messages-modal">
                  ${thread.messages.map(msg => `<li><span class="search-result-sender-modal">(${msg.sender})</span> ${msg.message}</li>`).join('')}
                </ul>
              </a>
            </li>`;
          });
          resultsHtml += '</ul>';
          searchResultsDisplay.innerHTML = resultsHtml;
        } else {
          searchResultsDisplay.innerHTML = '<p>검색 결과가 없습니다.</p>';
        }
      } catch (error) {
        console.error("Search failed:", error);
        searchResultsDisplay.innerHTML = `<p style="color: red;">검색 중 오류가 발생했습니다: ${error.message}</p>`;
      }
    }

    // --- 채팅 삭제 리스너 초기화 ---
    if (window.App?.addDeleteEventListeners) {
      window.App.addDeleteEventListeners();
    }
    
    // --- 페이지 로드 시 사이드바 상태 최종 업데이트 ---
    updateSidebar();
  });
</script>
</html>